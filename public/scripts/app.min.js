String.prototype.pluralize=function(a){if(a==undefined){a=0}return a+" "+((a==1||a=="1")?this:this+"s")};String.prototype.toTitleCase=function(){return this.replace(/([\w&`'‘’"“.@:\/\{\(\[<>_]+-? *)/g,function(b,d,a,c){if(a>0&&c.charAt(a-2)!==":"&&b.search(/^(a(nd?|s|t)?|b(ut|y)|en|for|i[fn]|o[fnr]|t(he|o)|vs?\.?|via)[ \-]/i)>-1){return b.toLowerCase()}if(c.substring(a-1,a+1).search(/['"_{(\[]/)>-1){return b.charAt(0)+b.charAt(1).toUpperCase()+b.substr(2)}if(b.substr(1).search(/[A-Z]+|&|[\w]+[._][\w]+/)>-1||c.substring(a-1,a+1).search(/[\])}]/)>-1){return b}return b.charAt(0).toUpperCase()+b.substr(1)})};String.prototype.escape=function(){return escape(this.replace(/\s/g,"-"))};String.prototype.unescape=function(){return unescape(this).replace(/[-_]/g," ")};Date.prototype.duration=function(a,c){var d=a.getTime()-this.getTime();if(c=="seconds"){d=Math.round(d/1000)}else{if(c=="minutes"){d=Math.round(d/(60000))}else{if(c=="words"){d=Math.round(d/1000);if(d<=0){d="now"}else{if(d>=1&&d<=3599){d="min".pluralize(Math.ceil(d/60))}else{if(d>=3600&&d<=86399){var b=Math.floor(d/3600);var g=(d%3600)/60;if(g<30){d="hour".pluralize(b)}else{d="hour".pluralize(b+0.5)}}else{if(d>=86400&&d<=2591999){var f=Math.floor(d/86400);var e=(d%86400)/3600;if(e<12){d="day".pluralize(f)}else{d="day".pluralize(f+0.5)}}else{if(d<=2592000&&d<=31535999){d="mth".pluralize(Math.ceil(d/2592000))}else{d="yr".pluralize(Math.ceil(d/31536000))}}}}}}}}return d};Date.prototype.next=function(a){var b=new Date(this.getTime());if(a=="millisecond"||a==undefined){b.setMilliseconds(this.getMilliseconds()+1)}else{if(a=="second"){b.setSeconds(this.getSeconds()+1);b.setMilliseconds(0)}else{if(a=="minute"){b.setMinutes(this.getMinutes()+1);b.setSeconds(0);b.setMilliseconds(0)}else{if(a=="hour"){b.setHours(this.getHours()+1);b.setMinutes(0);b.setSeconds(0);b.setMilliseconds(0)}}}}return b};Date.prototype.format=function(){var a=this.getHours()<=12?this.getHours():this.getHours()-12;if(this.getHours()===0){a=12}var c=this.getMinutes()<10?"0"+this.getMinutes():this.getMinutes();var b=this.getHours()<12?"am":"pm";return a+":"+c+" "+b};Date.__original_parse__=Date.parse;Date.parse=function(f){var a=new Date();if(_(f).isNumber()){a.setTime(f)}else{if(_(f).isDate()){a=f}else{if(_(f).isString()){var d=f.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).(\d{3})(Z)/);if(d){var g=parseInt(d[1],10),e=parseInt(d[2],10),h=parseInt(d[3],10),i=parseInt(d[4],10),c=parseInt(d[5],10),j=parseInt(d[6],10),b=parseInt(d[7],10);a=new Date(Date.UTC(g,e-1,h,i,c,j,b))}else{a=Date.__original_parse__(f)}}else{a=Date.__original_parse__(f)}}}return a};Date.now=function(){return new Date()};var App={Models:{},Views:{},Routers:{}};$(function(){$.support.WebKitAnimationEvent=(typeof WebKitTransitionEvent=="object");var b="active";$("body").delegate("a.fx:not(.disabled):not(.submit)","click",function(){$(this).parents(".page").attr("data-fx",$(this).attr("class"))});var c=function(i,h){var e="fx in out flip slide pop cube swap slideup dissolve fade reverse";var g=$(".page:visible");i=$(i);var d=g.attr("data-fx");if(_.isEmpty(d)){d="fx slideup reverse"}g.removeAttr("data-fx");$(":focus").blur();$(g).add(i).removeClass(e).addClass(d);var f=function(){g.removeClass(b).add(i).removeClass(e);if(_.isFunction(h)){h(i)}};i.one("webkitAnimationEnd",f);i.addClass(b).addClass("in");g.addClass("out");if(!$.support.WebKitAnimationEvent){f()}};var a=function(f,e,h){f=$(f);var g=750;var d=function(i,j,k){i.animate({opacity:0.5},j,"linear",function(){i.animate({opacity:1},j,"linear",function(){if(!_.isUndefined(k)&&_.isFunction(k)){k()}})})};d(f,g,function(){d(f,g,function(){d(f,g,function(){f.slideUp("slow",function(){f.remove()})})})})};App.Models.Location=Backbone.Model.extend();App.Models.Locations=Backbone.Collection.extend({model:App.Models.Location,url:"/api/locations.json",parse:function(e){var d=this;return _(e).map(function(f){return{name:f}})},search:function(d,e){var g=new RegExp("^"+d,"i"),f=new Array();if(e){g=new RegExp("^"+d+"$","i")}this.each(function(h){if(h.get("name").match(g)){f.push(h.get("name"))}});return f}});App.Models.Journey=Backbone.Model.extend({initialize:function(){this.set({departure:Date.parse(this.get("departure")),arrival:Date.parse(this.get("arrival")),origin:this.get("origin").unescape().toTitleCase(),destination:this.get("destination").unescape().toTitleCase()});this.unset("eta")},eta:function(d){if(_(d).isUndefined()){d="words"}return Date.now().duration(this.get("departure"),d)},className:function(){var d="",e=this.eta("minutes");if(e<="5"){d="now"}else{if(e<="10"){d="soon"}}return d},toJSON:function(){return _(Backbone.Model.prototype.toJSON.call(this)).extend({eta:this.eta(),className:this.className()})}});App.Models.Journeys=Backbone.Collection.extend({model:App.Models.Journey,limit:1,initialize:function(e,d){_(this).bindAll();_(this).extend({origin:d.origin,destination:d.destination,inverse:d.inverse});if(_.isUndefined(this.inverse)){_(this).extend({inverse:new App.Models.Journeys([],{origin:this.destination,destination:this.origin,inverse:this})})}},url:function(d){if(_(d).isUndefined()){d=this.limit}return("/api/"+this.origin.escape()+"/"+this.destination.escape()+".json?limit="+d).toLowerCase()},parse:function(e){var d=this;return _(e).map(function(f){return{origin:d.origin,originPlatform:f.origin.platform,destination:d.destination,destinationPlatform:f.destination.platform,departure:f.origin.datetime,arrival:f.destination.datetime}})},next:function(g,d){var e=this,f=new App.Models.Journeys([],{origin:e.origin,destination:e.destination});f.url=e.url(d);if(e.length>0){f.url+="&after="+JSON.stringify(e.last().get("departure")).escape()}f.fetch({success:function(){e.add(f.toJSON());if(_(g).isFunction()){g()}}})},remove:function(e,d){Backbone.Collection.prototype.remove.call(this,e,d)},expire:function(e){var d=this;if(this.length===0){this.next(e)}else{d.each(function(f){f.change();if(f.get("departure")<=(new Date(Date.now().getTime()+59*1000))){d.remove(f)}});if(this.length<this.limit){this.next(e,this.limit-this.length)}else{if(_(e).isFunction()){e()}}}},comparator:function(d){return d.get("departure")}});App.Models.Favourite=Backbone.Model.extend({initialize:function(e){var d=this;d.journeys=new App.Models.Journeys([],{origin:d.get("origin"),destination:d.get("destination")});if(e.inverse){d.unset("inverse");d.inverse=e.inverse}else{d.inverse=new App.Models.Favourite({origin:d.get("destination"),destination:d.get("origin"),inverse:d})}},url:function(e){if(_(e).isUndefined()){e=true}var d=e?"/#":"";return d+"/"+(this.get("origin")+"/"+this.get("destination")).escape().toLowerCase()},expire:function(){this.journeys.expire();this.inverse.journeys.expire()}});App.Models.Favourites=Backbone.Collection.extend({model:App.Models.Favourite,_cookie:"favourites",inverse:function(){return new App.Models.Favourites(this.map(function(d){return d.inverse}))},save:function(){$.cookie(this._cookie,JSON.stringify(this),{expires:7*52*25})},fetch:function(){var d=$.cookie(this._cookie);if(_(d).isString()&&!_(d).isEmpty()){var e=JSON.parse(d);if(_(e).isArray()){e=_(e).select(function(f){return _(f).isArray()&&_(f[0]).isString()&&_(f[1]).isString()&&!_(f[0]).isEmpty()&&!_(f[1]).isEmpty()});this.reset(_(e).map(function(f){return{origin:f[0],destination:f[1]}}))}}},toJSON:function(){return this.map(function(d){return[d.get("origin"),d.get("destination")]})},expire:function(){this.each(function(d){d.expire()})}});App.Views.Journey=Backbone.View.extend({tagName:"li",className:"journey",template:_.template($("#journey-template").html()),initialize:function(){_(this).bindAll("render");this.model.bind("change",this.render)},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this}});App.Views.Journeys=Backbone.View.extend({tagName:"ol",initialize:function(){_(this).bindAll("render","add","remove");this.collection.bind("reset",this.render);this.collection.bind("add",this.add);this.collection.bind("remove",this.remove)},render:function(){$(this.el).empty();var d=this;d.collection.each(function(e){d.add(e,false)});return d},add:function(e,f){if(!_(f).isBoolean()){f=true}var d=$((new App.Views.Journey({model:e,id:e.cid})).render().el);if(f){d.hide()}$(this.el).append(d);if(f){d.slideDown()}},remove:function(d){a($(this.el).find("#"+d.cid))}});App.Views.Page=Backbone.View.extend({tagName:"div",className:"page",initialize:function(){_(this).bindAll("render");if(!_(this.collection).isUndefined()){this.collection.bind("add",this.render);this.collection.bind("reset",this.render);this.collection.bind("remove",this.render)}},render:function(){var f=$('<div id="header"></div>').html(this.header()),d=$('<div id="content"></div>').html(this.content()),e=$('<div id="footer"></div>').html(this.footer());$(this.el).empty().append(f).append(d).append(e);return this},header:function(){return _.template($("#header-template").html())},content:function(){return $("")},footer:function(){return _.template($("#footer-template").html())}});App.Views.About=App.Views.Page.extend({id:"about",events:{"click #header-right-button":"done"},header:function(){return _.template($("#header-template").html())},content:function(){return _.template($("#about-template").html())},footer:function(){return $("")},done:function(d){history.back();d.preventDefault()}});App.Views.Settings=App.Views.Page.extend({id:"settings",events:{"click #header-right-button":"done"},header:function(){return _.template($("#header-template").html())},content:function(){return _.template($("#settings-template").html(),{collection:this.collection.toJSON()})},footer:function(){return $("")},done:function(g){var d=this,h=false,i=[],f=0;d.$("form li").each(function(){var k=$.trim($(this).find("input.origin").attr("value").toTitleCase()),e=$.trim($(this).find("input.destination").attr("value").toTitleCase());if(!_(k).isEmpty()&&!_(e).isEmpty()){var j=d.collection.find(function(l){return _(k).isEqual(l.get("origin"))&&_(e).isEqual(l.get("destination"))});if(_(j).isUndefined()){h=true;i.push(new App.Models.Favourite({origin:k,destination:e}))}else{i.push(j)}f++}});d.collection.reset(i);d.collection.save();if(this.collection.length>0){window.location.hash=this.collection.first().url(false)}g.preventDefault()}});App.Views.Favourite=App.Views.Page.extend({events:{"click button":"load"},initialize:function(d){_(this).bindAll("header","footer","content","load");this.partial=new App.Views.Journeys({collection:this.model.journeys});this.inverse=false||d.inverse},header:function(){return _.template($("#journey-header-template").html(),{url:this.model.inverse.url(),inverse:this.inverse})},content:function(){return $('<div class="journeys"></div>').append(this.partial.render().el).append(_.template($("#load-template").html())())},load:function(){var g=false,f=this.$("button"),e=f.attr("disabled","disabled").hasClass("expire-only");var d=function(h,l){var h=$(h),i="transparent",k=h.find("span"),m=l;if(_.isFunction(l)){m=l()}if(m){k.removeClass(i)}else{var j=k.filter("."+i).first();if(j.length>0){j.removeClass(i)}else{k.addClass(i).first().removeClass(i)}window.setTimeout(function(){d(h,l)},250)}};window.setTimeout(function(){d(f,function(){return g})},250);if(e){this.model.journeys.expire(function(){f.removeClass("expire-only").removeAttr("disabled");g=true})}else{this.model.journeys.next(function(){f.removeAttr("disabled");g=true})}},footer:function(){return _.template($("#footer-template").html(),{collection:this.collection,index:this.collection.indexOf(this.model)})}});App.Views.Favourites=Backbone.View.extend({tagName:"div",id:"favourites",initialize:function(d){_(this).bindAll("render");this.collection.bind("reset",this.render);this.collection.bind("add",this.render);this.collection.bind("remove",this.render)},render:function(){var d=this,e=this.partials();$(d.el).empty();_(e).each(function(f){$(d.el).append(f.render().el)});$("button:not(.disabled)").addClass("expire-only").click();return d},partials:function(){var d=this,e=undefined;e=d.collection.map(function(f){return new App.Views.Favourite({model:f,id:f.cid,collection:d.collection})});e=e.concat(d.collection.inverse().map(function(f){return new App.Views.Favourite({model:f,id:f.cid,collection:d.collection.inverse(),inverse:true})}));return e}});App.Routers.About=Backbone.Router.extend({routes:{"/about":"about"},initialize:function(d){this.view=new App.Views.About();$("body").append(this.view.render().el)},about:function(){c("#"+this.view.id)}});App.Routers.Settings=Backbone.Router.extend({routes:{"/settings":"settings"},initialize:function(d){this.locations=d.locations;this.view=new App.Views.Settings({collection:d.collection});$("body").append(this.view.render().el)},settings:function(){if(this.locations.length===0){this.locations.fetch()}c("#"+this.view.id)}});App.Routers.Journey=Backbone.Router.extend({routes:{"":"root","/":"root","/:origin/:destination":"journey"},initialize:function(d){this.collection=d.collection;this.view=new App.Views.Favourites({collection:this.collection});var e=this.view.render().el;$("body").append(e)},root:function(){window.location.hash=(this.collection.length>0)?this.collection.first().url(false):"/settings"},journey:function(e,d){e=e.unescape().toTitleCase();d=d.unescape().toTitleCase();var f=function(h){return _(e).isEqual(h.get("origin"))&&_(d).isEqual(h.get("destination"))},g=this.collection.find(f)||this.collection.inverse().find(f);if(_(g).isUndefined()){if(this.collection.length<7){this.collection.add({origin:e,destination:d});this.collection.save();g=this.collection.find(f);c($("#"+g.cid))}else{window.location.hash="/settings"}}else{c($("#"+g.cid))}}});_(App).extend({favourites:new App.Models.Favourites(),locations:new App.Models.Locations(),initialize:function(){this.favourites.fetch();var g=new App.Routers.About(),f=new App.Routers.Settings({collection:this.favourites,locations:this.locations}),e=new App.Routers.Journey({collection:this.favourites}),d=this;Backbone.history.start();$("input.origin, input.destination").autocomplete({minLength:1,source:function(j,i){i(d.locations.search(j.term))}});var h=function(){$("button:not(.disabled)").addClass("expire-only").click();window.setTimeout(h,(Date.now().next("minute")-Date.now()))};h()}});App.initialize()});